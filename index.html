<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Casa di Marco â€” Dashboard</title>

  <!-- Chart.js per il trend (fallback gestito sotto se non carica) -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js" defer></script>

  <style>
    :root{
      --bg-1: #0c1b2a;
      --bg-2: #0f2436;
      --card: rgba(255,255,255,0.06);
      --card-hover: rgba(255,255,255,0.10);
      --accent: #4cc9f0;
      --ok: #21c55d;
      --warn: #f59e0b;
      --danger: #ef4444;
      --muted: #a6b1bb;
      --text: #e6eef6;
    }
    *{ box-sizing: border-box; }
    html, body{ height:100%; }
    body{
      margin:0; font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, sans-serif;
      color: var(--text); background: radial-gradient(1200px 600px at 20% -20%, #18324b 0, transparent 70%), 
                           radial-gradient(800px 500px at 100% 0%, #102538 20%, transparent 60%),
                           linear-gradient(180deg, var(--bg-1), var(--bg-2));
    }
    .wrap{ max-width: 1080px; margin: 0 auto; padding: 20px; }

    header{
      display:flex; align-items:center; justify-content:space-between;
      gap: 12px; padding: 8px 0 18px;
    }
    .state-badge{
      font-weight:700; padding:6px 10px; border-radius:20px; background: var(--card); color:#7ef5b2;
      border:1px solid rgba(255,255,255,0.08); letter-spacing:.3px;
    }
    .title{
      display:flex; align-items:center; gap:12px; flex-wrap:wrap;
    }
    .title h1{ margin:0; font-size:20px; }
    .top-right{
      display:flex; align-items:center; gap:12px;
    }
    .chip{
      display:inline-flex; align-items:center; gap:8px; padding:6px 10px; border-radius:16px;
      background: var(--card); color: var(--text); border:1px solid rgba(255,255,255,0.08);
      font-size: 13px;
    }
    .chip .badge{
      display:inline-flex; min-width: 18px; height:18px; align-items:center; justify-content:center;
      padding:0 6px; border-radius:10px; background: var(--danger); color:#fff; font-weight:700; font-size:12px;
    }
    .unit-toggle{ cursor:pointer; user-select:none; }
    .unit-toggle b{ color: var(--accent); }

    .grid{
      display:grid; gap:14px;
      grid-template-columns: repeat(12, 1fr);
    }
    .card{
      background: var(--card); border: 1px solid rgba(255,255,255,0.08); border-radius:14px; padding:14px;
      transition: background .2s ease, border-color .2s ease;
    }
    .card:hover{ background: var(--card-hover); border-color: rgba(255,255,255,0.16); }
    .card h3{ margin:0 0 10px; font-size:14px; color: var(--muted); font-weight:600; letter-spacing:.3px; }

    /* Layout */
    .col-6{ grid-column: span 6; }
    .col-4{ grid-column: span 4; }
    .col-3{ grid-column: span 3; }
    .col-8{ grid-column: span 8; }
    .col-12{ grid-column: span 12; }

    /* Tiles */
    .tile{
      display:flex; align-items:center; justify-content:space-between; gap:10px;
      padding:12px; border-radius:12px; background: rgba(255,255,255,0.04);
      border:1px dashed rgba(255,255,255,0.08);
    }
    .tile .left{ display:flex; align-items:center; gap:10px; }
    .pill{
      display:inline-flex; align-items:center; gap:6px; padding:4px 8px; border-radius:999px;
      background: rgba(255,255,255,0.08); font-size:12px; color:#d6dee6; border:1px solid rgba(255,255,255,0.10);
    }
    .btn{
      display:inline-flex; align-items:center; gap:8px; padding:8px 12px; border-radius:10px; cursor:pointer;
      border:1px solid rgba(255,255,255,0.14); background: linear-gradient(180deg, rgba(255,255,255,0.06), rgba(255,255,255,0.02));
      color: var(--text); font-weight:600;
    }
    .btn:hover{ background: linear-gradient(180deg, rgba(255,255,255,0.12), rgba(255,255,255,0.04)); }
    .btn.outline{ background: transparent; }
    .btn.ok{ border-color: rgba(33,197,93,.5); color:#b0ffd2; }
    .btn.warn{ border-color: rgba(245,158,11,.5); color:#ffe4b8; }
    .btn.danger{ border-color: rgba(239,68,68,.5); color:#ffc2c2; }

    /* Weather block */
    .weather{
      display:flex; align-items:center; justify-content:flex-start; gap:16px;
    }
    .weather .big{
      font-size:42px; font-weight:800; letter-spacing:.5px;
    }
    .weather .emoji{ font-size:32px; filter: drop-shadow(0 0 10px rgba(255,255,255,.1)); }
    .muted{ color: var(--muted); font-size: 12px; }

    /* People status */
    .people{
      display:flex; flex-wrap:wrap; gap:10px;
    }
    .avatar{
      display:flex; align-items:center; gap:8px; padding:6px 10px; border-radius:12px; background: rgba(255,255,255,0.04);
      border:1px solid rgba(255,255,255,0.08); font-weight:600;
    }
    .dot{ width:10px; height:10px; border-radius:50%; background:#777; box-shadow:0 0 0 2px rgba(255,255,255,0.08) inset; }
    .dot.online{ background: var(--ok); }
    .dot.offline{ background: #666; }

    /* Favorites (Admin) */
    .fav-grid{
      display:grid; gap:12px; grid-template-columns: repeat(3, 1fr);
    }
    .fav{ padding:12px; border-radius:12px; background: rgba(255,255,255,0.04); border: 1px solid rgba(255,255,255,0.08); }
    .fav h4{ margin:0 0 8px; font-size:14px; color:#cdd7e1; }
    .row{ display:flex; gap:8px; flex-wrap:wrap; }

    /* Trend */
    .chart-wrap{ position:relative; height:180px; }
    canvas{ width:100%; height:100%; }

    /* Toast */
    .toast{
      position:fixed; right:16px; bottom:16px; background:#111a24; color:#eafff5; padding:10px 12px; border-radius:10px;
      border:1px solid rgba(255,255,255,0.18); box-shadow: 0 8px 24px rgba(0,0,0,0.3); z-index: 9999; opacity:0; transform: translateY(10px);
      transition: all .25s ease;
    }
    .toast.show{ opacity:1; transform: translateY(0); }

    /* Skeleton */
    .skeleton{ position:relative; overflow:hidden; background: rgba(255,255,255,0.04); }
    .skeleton::after{
      content:''; position:absolute; inset:0; transform: translateX(-100%); 
      background: linear-gradient(90deg, transparent, rgba(255,255,255,0.06), transparent);
      animation: shimmer 1.2s infinite;
    }
    @keyframes shimmer{ 100%{ transform: translateX(100%);} }

    @media (max-width: 900px){
      .col-6, .col-4, .col-3, .col-8, .col-12{ grid-column: span 12; }
      .fav-grid{ grid-template-columns: repeat(2, 1fr); }
    }
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <div class="title">
        <span class="state-badge" id="stateBadge">â€”</span>
        <h1>Casa di Marco</h1>
      </div>
      <div class="top-right">
        <div class="chip">
          <span id="logBadgeLabel">Log</span>
          <span class="badge" id="logBadge"></span>
        </div>
        <div class="chip unit-toggle" id="unitToggle">UnitÃ : <b id="unitLabel">Â°C</b></div>
        <div class="chip" title="Aggiorna ora">
          <span id="nowIso">â€”</span>
        </div>
      </div>
    </header>

    <section class="grid">
      <!-- People + Energy -->
      <div class="card col-6">
        <h3>Dashboard</h3>
        <div class="grid">
          <div class="card col-6">
            <div class="tile">
              <div class="left">
                <div class="pill">Persone</div>
              </div>
              <div><b id="peopleSummary">â€”</b></div>
            </div>
            <div class="people" id="peopleList"></div>
          </div>
          <div class="card col-6">
            <div class="tile">
              <div class="left">
                <div class="pill">Energy</div>
              </div>
              <div><b id="energyKwh">â€” kWh</b></div>
            </div>
            <div class="muted">Dispositivi offline: <b id="devicesOffline">0</b></div>
          </div>
        </div>
      </div>

      <!-- Weather -->
      <div class="card col-6">
        <h3>Meteo</h3>
        <div class="weather">
          <div class="emoji" id="weatherEmoji">â›…</div>
          <div class="big" id="tempNow">â€” Â°C</div>
        </div>
        <div class="muted" style="margin-top:8px;">
          Provider: <span id="weatherProvider">N/A</span>
          &nbsp;â€¢&nbsp; Stato: <span id="dayNight">â€”</span>
        </div>
      </div>

      <!-- Preferiti (Admin) -->
      <div class="card col-12">
        <h3>Preferiti</h3>
        <div class="fav-grid">
          <div class="fav">
            <h4>Vacanza</h4>
            <div class="row">
              <button class="btn ok"    data-admin="set_vacanza" data-value="true">Attiva</button>
              <button class="btn outline" data-admin="set_vacanza" data-value="false">Disattiva</button>
            </div>
          </div>
          <div class="fav">
            <h4>Override</h4>
            <div class="row">
              <button class="btn warn"  data-admin="set_override" data-value="true">Attiva</button>
              <button class="btn outline" data-admin="set_override" data-value="false">Disattiva</button>
            </div>
          </div>
          <div class="fav">
            <h4>Piante</h4>
            <div class="row">
              <button class="btn" data-admin="piante">Esegui ora</button>
            </div>
          </div>
          <div class="fav">
            <h4>Tapparelle â–²</h4>
            <div class="row">
              <button class="btn" data-admin="alza_tutto">Alza tutto</button>
            </div>
          </div>
          <div class="fav">
            <h4>Tapparelle â–¼</h4>
            <div class="row">
              <button class="btn danger" data-admin="abbassa_tutto">Abbassa tutto</button>
            </div>
          </div>
          <div class="fav">
            <h4>VIMAR (esempio)</h4>
            <div class="row">
              <button class="btn" data-vimar="shutter" data-id="SALA_01" data-cmd="up">SALA â†‘</button>
              <button class="btn" data-vimar="shutter" data-id="SALA_01" data-cmd="down">SALA â†“</button>
              <button class="btn outline" data-vimar="shutter" data-id="SALA_01" data-cmd="stop">SALA â– </button>
            </div>
          </div>
        </div>
      </div>

      <!-- Trend 24h -->
      <div class="card col-8">
        <h3>Trend 24h (presenza)</h3>
        <div class="chart-wrap skeleton" id="trendSkeleton"><canvas id="trend24h"></canvas></div>
      </div>

      <!-- Log ultimi -->
      <div class="card col-4">
        <h3>Log recenti</h3>
        <div id="logList" style="display:grid; gap:8px; max-height:200px; overflow:auto;"></div>
        <div class="muted" id="logEmpty" style="display:none;">Nessun log recente.</div>
      </div>
    </section>
  </div>

  <div class="toast" id="toast"></div>

<script>
/* ================================
 *  CONFIG
 * ================================ */
const WEBAPP_URL = 'https://script.google.com/macros/s/AKfycbzx-jta1hBn-PZmXj7IGhpO_B2uNAz_G5BrGaQ6V7lZYEf2VBXGHCyr_ho8Xlo7jNEj/exec';
const REFRESH_MS = 60_000;  // 1 minuto
const UNIT_LS_KEY = 'dash.unit'; // 'C' o 'F'

/* ================================
 *  UTILS
 * ================================ */
function toast(msg, ms=2200){
  const t = document.getElementById('toast');
  t.textContent = msg; t.classList.add('show');
  setTimeout(()=> t.classList.remove('show'), ms);
}
function qs(sel){ return document.querySelector(sel); }
function qsa(sel){ return Array.from(document.querySelectorAll(sel)); }

function toNum(val){
  if (typeof val === 'number') return val;
  const s = String(val||'').replace(',', '.').replace(/[^\d.\-]/g,'').trim();
  const n = Number(s); return isFinite(n)?n:null;
}
function cToF(c){ return c==null? null : (c*9/5 + 32); }
function fmtTemp(n, unit='C'){
  if (n==null || !isFinite(n)) return 'â€”';
  const v = (unit==='F') ? cToF(n) : n;
  return Math.round(v) + 'Â°' + unit;
}
function wmoEmoji(code){
  const m = {
    '0':'â˜€ï¸','1':'ðŸŒ¤ï¸','2':'â›…','3':'â˜ï¸',
    '45':'ðŸŒ«ï¸','48':'ðŸŒ«ï¸',
    '51':'ðŸŒ¦ï¸','53':'ðŸŒ¦ï¸','55':'ðŸŒ¦ï¸',
    '61':'ðŸŒ§ï¸','63':'ðŸŒ§ï¸','65':'ðŸŒ§ï¸',
    '66':'ðŸŒ§ï¸â„ï¸','67':'ðŸŒ§ï¸â„ï¸',
    '71':'ðŸŒ¨ï¸','73':'ðŸŒ¨ï¸','75':'ðŸŒ¨ï¸',
    '77':'â„ï¸',
    '80':'ðŸŒ¦ï¸','81':'ðŸŒ§ï¸','82':'â›ˆï¸',
    '85':'â„ï¸','86':'â„ï¸',
    '95':'â›ˆï¸','96':'â›ˆï¸','99':'â›ˆï¸'
  };
  return m[String(code)] || 'â›…';
}
function stateColor(state){
  const s = String(state||'').toUpperCase();
  if (s.includes('COMFY')) return '#7ef5b2';
  if (s.includes('SECURITY_NIGHT')) return '#ffd1a6';
  if (s.includes('SECURITY')) return '#ffe28a';
  return '#cde3ff';
}

/* JSON first, JSONP fallback */
async function getJSON(url){
  try{
    const r = await fetch(url, { cache:'no-store' });
    const ct = r.headers.get('content-type')||'';
    if (ct.includes('application/json')) return await r.json();
    // se torna JS/JSONP, proviamo a estrarre
    const txt = await r.text();
    const m = txt.match(/^[\w$]+\((.*)\);?$/s);
    if (m) return JSON.parse(m[1]);
    return JSON.parse(txt);
  }catch(e){
    // fallback JSONP classico
    return jsonp(url);
  }
}
function jsonp(url){
  return new Promise((resolve,reject)=>{
    const cb = 'cb_'+Date.now()+'_'+Math.floor(Math.random()*1e6);
    window[cb] = (data)=>{ resolve(data); cleanup(); };
    function cleanup(){ try{ delete window[cb]; }catch(_){}
      if (script && script.parentNode) script.parentNode.removeChild(script); }
    const script = document.createElement('script');
    const sep = url.includes('?') ? '&' : '?';
    script.src = url + sep + 'callback=' + cb;
    script.onerror = ()=>{ cleanup(); reject(new Error('JSONP error')); };
    document.head.appendChild(script);
  });
}

/* ================================
 *  DATA LOADERS
 * ================================ */
async function loadModel(){
  const url = WEBAPP_URL + '?t=' + Date.now();
  return await getJSON(url);
}
async function loadTrend(){
  const url = WEBAPP_URL + '?trend=24h&t=' + Date.now();
  return await getJSON(url);
}
async function loadLogs(){
  const url = WEBAPP_URL + '?logs=1&t=' + Date.now();
  return await getJSON(url);
}

/* ================================
 *  RENDER
 * ================================ */
let trendChart = null;
function render(model){
  // meta
  qs('#nowIso').textContent = (model.meta && model.meta.nowIso) ? new Date(model.meta.nowIso).toLocaleString() : 'â€”';

  // state
  qs('#stateBadge').textContent = String(model.state||'â€”');
  qs('#stateBadge').style.color = stateColor(model.state);

  // notte/giorno
  qs('#dayNight').textContent = model.notte ? 'NOTTE' : 'GIORNO';

  // people
  const people = Array.isArray(model.people) ? model.people : [];
  const online = people.filter(p => p.onlineSmart || p.onlineRaw);
  qs('#peopleSummary').textContent = `${people.length} Â· ${online.length>0 ? 'Casa occupata' : 'Casa vuota'}`;
  const list = qs('#peopleList'); list.innerHTML = '';
  people.forEach(p=>{
    const el = document.createElement('div');
    el.className='avatar';
    el.innerHTML = `<span class="dot ${ (p.onlineSmart || p.onlineRaw) ? 'online':'offline' }"></span>${p.name}`;
    list.appendChild(el);
  });

  // energy
  const kwh = model.energy && model.energy.kwh;
  qs('#energyKwh').textContent = (kwh==null || !isFinite(kwh)) ? 'â€” kWh' : `${kwh.toFixed(1)} kWh`;
  const off = (model.devicesOfflineCount==null?0:model.devicesOfflineCount);
  qs('#devicesOffline').textContent = off;

  // alerts
  const errs = model.alerts && model.alerts.logErrors || 0;
  qs('#logBadge').textContent = errs>0 ? String(errs) : '';
  qs('#logBadge').style.display = errs>0 ? 'inline-flex' : 'none';

  // weather
  const unit = (localStorage.getItem(UNIT_LS_KEY)||'C').toUpperCase();
  qs('#unitLabel').textContent = 'Â°'+unit;

  const w = model.weather || {};
  qs('#weatherEmoji').textContent = wmoEmoji(w.icon);
  qs('#tempNow').textContent = fmtTemp(w.tempC, unit);
  qs('#weatherProvider').textContent = (w.provider||'').replace('Openâ€‘','Open-');

  // trend (loaded separatamente)
}

function renderTrend(tr){
  const el = qs('#trend24h').getContext('2d');
  const data = Array.isArray(tr.trend24h) ? tr.trend24h : [];
  const labels = data.map(x => x.t.slice(11,16));
  const values = data.map(x => Number(x.present)||0);

  // fine skeleton
  const sk = qs('#trendSkeleton'); sk.classList.remove('skeleton');

  try{
    if (trendChart){ trendChart.destroy(); }
    trendChart = new Chart(el, {
      type: 'line',
      data: {
        labels,
        datasets: [{
          label: 'Presenza (5min)',
          data: values,
          tension: .25,
          fill: true,
          borderColor: '#4cc9f0',
          backgroundColor: 'rgba(76,201,240,.25)',
          pointRadius: 0,
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        scales: {
          x: { display:false },
          y: { suggestedMin:0, suggestedMax:1, ticks:{ stepSize:1 } }
        },
        plugins: { legend:{ display:false } }
      }
    });
  }catch(e){
    // fallback semplice
    el.canvas.outerHTML = `<div class="muted">Trend non disponibile (${e})</div>`;
  }
}

function renderLogs(payload){
  const arr = Array.isArray(payload.logs) ? payload.logs : [];
  const box = qs('#logList'); box.innerHTML = '';
  if (arr.length===0){ qs('#logEmpty').style.display='block'; return; }
  qs('#logEmpty').style.display='none';
  arr.slice(0,30).forEach(l=>{
    const d = (l.ts ? new Date(l.ts) : null);
    const when = d ? d.toLocaleString() : 'â€”';
    const el = document.createElement('div');
    el.className='tile';
    el.innerHTML = `
      <div class="left">
        <div class="pill">${when}</div>
        <div>${(l.code||'').toUpperCase()}</div>
      </div>
      <div class="muted">${l.desc||''}</div>
    `;
    box.appendChild(el);
  });
}

/* ================================
 *  ACTIONS (Admin + VIMAR)
 * ================================ */
async function callAdmin(eventName, extra={}){
  const params = new URLSearchParams({ admin:'1', event: eventName, t: Date.now() });
  Object.entries(extra).forEach(([k,v]) => params.set(k, v));
  const url = WEBAPP_URL + '?' + params.toString();
  const res = await getJSON(url);
  return res;
}
function bindAdminButtons(){
  qsa('[data-admin]').forEach(btn=>{
    btn.addEventListener('click', async ()=>{
      const evt = btn.getAttribute('data-admin');
      const val = btn.getAttribute('data-value');
      try{
        const payload = {};
        if (val!=null) payload.value = String(val);
        await callAdmin(evt, payload);
        toast('OK: '+evt+(val!=null? ' â†’ '+val:''));
        // dopo admin state cambia â†’ refresh model
        await refreshAll();
      }catch(e){
        toast('Errore: '+e.message);
      }
    });
  });
  qsa('[data-vimar]').forEach(btn=>{
    btn.addEventListener('click', async ()=>{
      const type = btn.getAttribute('data-vimar'); // shutter|thermo|hvac
      const id   = btn.getAttribute('data-id');
      const cmd  = btn.getAttribute('data-cmd') || btn.getAttribute('data-op');
      try{
        if (type==='shutter'){
          await callAdmin('vimar_shutter', { id, cmd });
        }else if (type==='thermo'){
          await callAdmin('vimar_thermo', { id, op: cmd });
        }else if (type==='hvac'){
          await callAdmin('vimar_hvac', { id, op: cmd });
        }
        toast(`VIMAR ${type} ${id} â†’ ${cmd}`);
      }catch(e){
        toast('Errore VIMAR: '+e.message);
      }
    });
  });
}

/* ================================
 *  INIT + REFRESH
 * ================================ */
async function refreshAll(){
  // skeleton attivo solo sul trend
  try{
    const [model, trend, logs] = await Promise.all([
      loadModel(),
      loadTrend(),
      loadLogs()
    ]);
    render(model);
    renderTrend(trend);
    renderLogs(logs);
  }catch(e){
    toast('Errore caricamento: '+e.message);
  }
}

function init(){
  // toggle unitÃ 
  const unit = (localStorage.getItem(UNIT_LS_KEY)||'C').toUpperCase();
  localStorage.setItem(UNIT_LS_KEY, unit);
  qs('#unitLabel').textContent = 'Â°'+unit;
  qs('#unitToggle').addEventListener('click', ()=>{
    const cur = (localStorage.getItem(UNIT_LS_KEY)||'C').toUpperCase();
    const next = (cur==='C') ? 'F' : 'C';
    localStorage.setItem(UNIT_LS_KEY, next);
    qs('#unitLabel').textContent = 'Â°'+next;
    // re-render solo temp se abbiamo giÃ  un model in pagina:
    refreshAll();
  });

  bindAdminButtons();
  refreshAll();
  setInterval(refreshAll, REFRESH_MS);
}

document.addEventListener('DOMContentLoaded', init);
</script>
</body>
</html>
``
