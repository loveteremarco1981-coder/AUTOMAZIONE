<!doctype html>
<html lang="it">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Casa di Marco · Dashboard</title>
<style>
  :root{
    --bg:#0b0b0d; --text:#e7e7eb; --muted:#a0a0aa;
    --card:rgba(255,255,255,.08); --accent:#0a84ff;
    --r:22px; --blur:18px; --shadow:0 10px 30px rgba(0,0,0,.35);
    --tile:min(44vw,180px); --gap:14px;
  }
  *{box-sizing:border-box}
  body{margin:0;background:radial-gradient(1000px 600px at 70% -20%,#1b1b22 0,#0b0b0d 55%,#000);
       color:var(--text);font:16px/1.35 -apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Helvetica,Arial}
  .hdr{position:sticky;top:0;z-index:10;padding:22px 18px 12px;
       background:linear-gradient(180deg,rgba(0,0,0,.65),rgba(0,0,0,.2) 70%,transparent);
       backdrop-filter:blur(var(--blur))}
  .hdr h1{margin:0 0 6px;font-size:28px;font-weight:700}
  .muted{color:var(--muted);font-size:14px}
  .people{display:flex;gap:8px;margin:6px 0 8px;flex-wrap:wrap}
  .pill{padding:6px 10px;border-radius:999px;font-size:13px;background:rgba(255,255,255,.1)}
  .pill.in{background:rgba(46,170,78,.9);color:#fff}
  .pill.out{background:rgba(120,120,130,.35)}
  .tiles{display:grid;gap:var(--gap);padding:12px 16px 30px;
         grid-template-columns:repeat(auto-fill,minmax(var(--tile),1fr))}
  .tiles-room{grid-template-columns:repeat(auto-fill,minmax(160px,1fr))}
  .tile{border-radius:var(--r);background:var(--card);box-shadow:var(--shadow);padding:14px;min-height:120px;
        display:flex;flex-direction:column;justify-content:space-between;transition:.18s;user-select:none}
  .tile:hover{transform:translateY(-2px)}
  .label{font-weight:600}.value{font-size:26px;font-weight:700;margin-top:8px}
  .tile.on{background:linear-gradient(180deg,rgba(10,132,255,.92),rgba(10,132,255,.65));color:#fff}
  .tile.switch:not(.on){filter:saturate(.55) brightness(.85);opacity:.88}
  .click{cursor:pointer}
  .sec{padding:6px 16px 16px}.sec h2{margin:0 0 12px;font-size:20px}
  .room{margin-bottom:10px}.room h3{margin:8px 0 6px;font-size:16px;color:var(--muted)}
  .list .row{display:flex;justify-content:space-between;align-items:baseline;background:rgba(255,255,255,.05);
             padding:10px 12px;border-radius:14px;margin:6px 0}
  .toast{position:fixed;left:50%;bottom:28px;transform:translateX(-50%);background:rgba(0,0,0,.82);color:#fff;
         padding:10px 14px;border-radius:12px;box-shadow:var(--shadow);opacity:0;pointer-events:none;transition:.2s;z-index:9999}
  .toast.show{opacity:1}
  .dbg{position:fixed;right:8px;bottom:8px;font:12px/1.35 monospace;background:rgba(0,0,0,.5);color:#9ad8ff;
       padding:6px 8px;border-radius:8px;max-width:48vw;max-height:30vh;overflow:auto}
  @media (prefers-color-scheme:light){
    :root{--bg:#f2f2f7;--text:#101014;--card:rgba(255,255,255,.92);--muted:#6b6b76}
    body{background:linear-gradient(180deg,#f8f8fb,#ececf2)}
  }
</style>
</head>
<body>
  <header class="hdr">
    <h1 id="homeName">Casa di Marco</h1>
    <div id="people" class="people"></div>
    <div id="ts" class="muted">Aggiornamento…</div>
  </header>

  <!-- HOME -->
  <section class="tiles" id="homeTiles"></section>

  <!-- STANZE -->
  <section class="sec">
    <h2>Stanze</h2>
    <div id="rooms"></div>
  </section>

  <!-- AUTOMAZIONI -->
  <section class="sec">
    <h2>Automazioni</h2>
    <div id="log" class="list"></div>
  </section>

  <div id="toast" class="toast"></div>
  <pre id="dbg" class="dbg"></pre>

<script>
/* ============ CONFIG per il TUO GAS ============ */
const CONFIG = {
  title: "Casa di Marco",
  endpoint: "https://script.google.com/macros/s/AKfycbzx-jta1hBn-PZmXj7IGhpO_B2uNAz_G5BrGaQ6V7lZYEf2VBXGHCyr_ho8Xlo7jNEj/exec",
  pollMs: 4000,
  jsonp: { enabled: true, param: "callback" },

  /* Tile principali (matching con il tuo doGet) */
  tiles: [
    { id:"vacanza",  type:"switch", label:"Vacanza",  path:"vacanza",
      on:{ url:"admin=1&event=set_vacanza&value=true"  },
      off:{url:"admin=1&event=set_vacanza&value=false" } },
    { id:"presenza", type:"sensor", label:"Presenza", path:"presenzaEffettiva",
      format:v=>v?"In casa":"Assente" },
    { id:"piante",   type:"scene",  label:"Piante",   subtitle:"Apertura Tapparelle",
      action:{ url:"admin=1&event=piante", confirm:"Attivo modalità Apertura Tapparelle?" } },
    { id:"override", type:"switch", label:"Override", path:"override",
      on:{ url:"admin=1&event=set_override&value=true"  },
      off:{url:"admin=1&event=set_override&value=false" } },
  ],

  /* Stanze (Alba/Tramonto dal tuo modello) */
  rooms: [
    { id:"soggiorno", name:"Soggiorno", tiles:["presenza"] },
    { id:"esterno",   name:"Esterno",   tiles:["alba","tramonto","piante"] },
  ],
  virtual: { alba:{label:"Alba",path:"alba"}, tramonto:{label:"Tramonto",path:"tramonto"} },

  /* Log: il tuo doGet attuale non li fornisce → lasciamo vuoto/placeholder */
  logLimit: 20
};
/* ============ UTILS ============ */
const $=s=>document.querySelector(s), $$=s=>document.querySelectorAll(s);
const pick=(o,p)=>p.split('.').reduce((x,k)=>(x&&x[k]!==undefined)?x[k]:undefined,o);
const log=(...a)=>{const el=$("#dbg"); el.textContent=[new Date().toLocaleTimeString(),...a].join(" ")+"\n"+el.textContent;}
const toast=(m)=>{const t=$("#toast"); t.textContent=m; t.classList.add("show"); setTimeout(()=>t.classList.remove("show"),1600);};
const append=(base,qs)=> base + (base.includes("?")?"&":"?") + qs;

/* ============ SKELETON (visibile SUBITO) ============ */
function renderSkeleton(){
  $("#homeName").textContent=CONFIG.title;
  $("#homeTiles").innerHTML = CONFIG.tiles.map(t=>`
    <article class="tile ${t.type} ${t.type!=="sensor"?"click":""}" data-id="${t.id}">
      <div><div class="label">${t.label}</div>${t.subtitle?`<div class="muted">${t.subtitle}</div>`:""}</div>
      <div class="value muted">${t.type==="sensor"?"—":(t.type==="switch"?"Off":"Esegui")}</div>
    </article>`).join('');
  $("#rooms").innerHTML = CONFIG.rooms.map(r=>`
    <section class="room">
      <h3>${r.name}</h3>
      <div class="tiles tiles-room">
        ${r.tiles.map(id=>`<div class="tile-ref" data-ref="${id}"></div>`).join("")}
      </div>
    </section>`).join('');
  CONFIG.rooms.forEach(r=>{
    r.tiles.forEach(id=>{
      const host=document.querySelector(`.tile-ref[data-ref="${id}"]`);
      if(!host) return;
      if(CONFIG.virtual[id]){
        host.outerHTML=`
          <article class="tile sensor">
            <div class="label">${CONFIG.virtual[id].label}</div>
            <div class="value muted">—</div>
          </article>`;
        return;
      }
      const src=document.querySelector(`.tile[data-id="${id}"]`);
      if(src){ host.replaceWith(src.cloneNode(true)); }
    });
  });
}
renderSkeleton();

/* ============ BIND AZIONI con i TUOI event=... ============ */
function bindActions(){
  CONFIG.tiles.forEach(t=>{
    const el=document.querySelector(`.tile[data-id="${t.id}"]`);
    if(!el || el.dataset.bound) return;
    if(t.type==="switch"){
      el.onclick=async ()=>{
        const isOn=el.classList.contains("on");
        const qs=isOn?t.off.url:t.on.url;               // admin=1&event=set_xxx&value=...
        const url=append(CONFIG.endpoint, qs);
        try{
          log("SWITCH", t.label, "→", url);
          await fetch(url,{method:"GET",mode:"no-cors"});  // non ci serve la risposta
          toast(`${t.label}: ${isOn?"Off":"On"}`);
        }catch(e){ toast(`Errore ${t.label}`); log("ERR switch",e.message); }
      };
    }
    if(t.type==="scene"){
      el.onclick=async ()=>{
        if(t.action?.confirm && !confirm(t.action.confirm)) return;
        const url=append(CONFIG.endpoint, t.action.url);   // admin=1&event=piante
        try{
          log("SCENE", t.label, "→", url);
          await fetch(url,{method:"GET",mode:"no-cors"});
          toast(`${t.label}: eseguita`);
        }catch(e){ toast(`Errore scena ${t.label}`); log("ERR scene",e.message); }
      };
    }
    el.dataset.bound="1";
  });
}
bindActions();

/* ============ JSONP loader (per data) ============ */
function jsonp(url,cbParam="callback",timeoutMs=4000){
  return new Promise((res,rej)=>{
    const cb="cb_"+Math.random().toString(36).slice(2);
    const sep=url.includes("?")?"&":"?";
    const s=document.createElement("script");
    s.src=`${url}${sep}${cbParam}=${cb}`;
    const timer=setTimeout(()=>{cleanup(); rej(new Error("JSONP timeout"));}, timeoutMs);
    function cleanup(){clearTimeout(timer); s.remove(); delete window[cb];}
    window[cb]=(data)=>{cleanup(); res(data);};
    s.onerror=()=>{cleanup(); rej(new Error("JSONP error"));};
    document.head.appendChild(s);
  });
}

/* ============ DATI LIVE (model da doGet) ============ */
async function loadState(){
  $("#ts").textContent="Aggiornamento…";
  try{
    const model = await jsonp(CONFIG.endpoint, CONFIG.jsonp.param);
    $("#ts").textContent="Aggiornato: "+new Date().toLocaleTimeString();
    log("MODEL", JSON.stringify(model).slice(0,120)+"...");
    applyState(model);
  }catch(e){
    log("DATA ERR", e.message);
    $("#ts").textContent="Errore di connessione";
  }
}

/* ============ RENDER ============ */
function applyState(model){
  // Persone → dal tuo array model.people
  const ppl = Array.isArray(model.people)? model.people : [];
  $("#people").innerHTML = ppl.map(p=>{
    const v = !!(p.onlineSmart || p.onlineRaw);
    return `<span class="pill ${v?'in':'out'}">${p.name} · ${v?'In':'Out'}</span>`;
  }).join("");

  // HOME tiles
  CONFIG.tiles.forEach(t=>{
    const el=document.querySelector(`.tile[data-id="${t.id}"]`);
    if(!el) return;

    if(t.type==="sensor"){
      const v=pick(model,t.path);
      el.querySelector(".value").textContent = (t.format?t.format(v):v) ?? "—";
      el.classList.toggle("on", false);
    }
    if(t.type==="switch"){
      const on=!!pick(model,t.path);   // vacanza/override dal model
      el.querySelector(".value").textContent= on?"On":"Off";
      el.classList.toggle("on", on);
    }
    if(t.type==="scene"){
      el.querySelector(".value").textContent="Esegui";
      el.classList.toggle("on", false);
    }
  });

  // STANZE virtual (alba/tramonto)
  Object.entries(CONFIG.virtual).forEach(([id,vc])=>{
    const node=[...$$(".room .tile")].find(n=>n.querySelector(".label")?.textContent===vc.label);
    if(node){
      const val=pick(model, vc.path);
      node.querySelector(".value").textContent = (val==null || val==="") ? "—" : String(val).slice(0,16);
    }
  });

  // Automazioni — il tuo doGet non espone i log → placeholder
  $("#log").innerHTML = `<div class="row"><div class="name">Nessun evento</div>
                         <div class="muted">Aggiungi endpoint log</div></div>`;
}

/* ============ LOOP ============ */
loadState(); setInterval(loadState, CONFIG.pollMs);
</script>
</body>
</html>
