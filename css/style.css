/*******************************************************
 * HOMEKIT APP â€“ VERSIONE FINALE CORRETTA
 *******************************************************/

console.log("[LOAD] app.js â€“ CLEAN VERSION");

// ENDPOINT
const ENDPOINT = window.APP_CONFIG.endpoint;

/*******************************************************
 * Utility
 *******************************************************/
const delay = ms => new Promise(res => setTimeout(res, ms));

function toast(t){
  const el = document.getElementById("toast");
  el.textContent = t;
  el.classList.add("show");
  setTimeout(()=>el.classList.remove("show"),1500);
}

function fmt(d){
  if(!d) return "â€”";
  const dt = new Date(d);
  if(isNaN(dt)) return d;
  return dt.toLocaleString();
}
function fmtAgo(m){
  if(m==null) return "â€”";
  if(m<1) return "ora";
  if(m===1) return "1 min";
  return m+" min";
}

/*******************************************************
 * JSONP
 *******************************************************/
async function sendJSONP(url){
  return new Promise((resolve, reject)=>{
    const cb = "cb_"+Math.random().toString(36).slice(2);
    const sep = url.includes("?") ? "&" : "?";
    const s = document.createElement("script");

    window[cb] = (data)=>{
      resolve(data);
      delete window[cb];
      s.remove();
    };

    s.onerror = ()=>{
      reject(new Error("JSONP ERROR"));
      delete window[cb];
      s.remove();
    };

    s.src = url + sep + "callback=" + cb;
    document.head.appendChild(s);
  });
}

/*******************************************************
 * RENDER â€“ stato, persone, orari, eventi
 *******************************************************/
function renderState(model){
  const st = model.state || "â€”";

  document.getElementById("state-pill").textContent = st;
  document.getElementById("state-pill-dup").textContent = st;

  const notte = st.toUpperCase().includes("NIGHT");
  document.getElementById("notte").textContent = notte ? "NOTTE" : "GIORNO";

  const flags = [];
  if(model.vacanza) flags.push("vacanza");
  if(model.override) flags.push("override");
  flags.push(notte ? "notte" : "giorno");
  document.getElementById("meta-flags").textContent = flags.join(" Â· ");

  document.getElementById("meta-time").textContent = fmt(model.meta.nowIso);
  document.getElementById("last-event").textContent = model.lastEvent || "â€”";
}

function renderPeople(list){
  const box = document.getElementById("people-list");
  box.innerHTML = "";
  (list||[]).forEach(p=>{
    const online = p.onlineSmart || p.onlineRaw;
    const li = document.createElement("li");
    li.className = "person";

    li.innerHTML = `
      <div>${p.name}</div>
      <div class="badge ${online?'in':'out'}">
        ${online?'IN':'OUT'}${p.lastLifeMinAgo!=null?' Â· '+fmtAgo(p.lastLifeMinAgo):''}
      </div>
    `;

    box.appendChild(li);
  });
}

function renderTime(m){
  document.getElementById("alba").textContent = fmt(m.alba);
  document.getElementById("tramonto").textContent = fmt(m.tramonto);
  document.getElementById("ora").textContent = fmt(m.meta.nowIso);
}

function renderNext(m){
  const n = m.next || {};
  document.getElementById("next-piante-alba").textContent = fmt(n.pianteAlba);
  document.getElementById("next-piante-close").textContent = fmt(n.piantePostClose);
}

function renderAll(model){
  renderState(model);
  renderPeople(model.people);
  renderTime(model);
  renderNext(model);
}

/*******************************************************
 * Tema dinamico giorno/notte
 *******************************************************/
function applyTheme(model){
  const st = model.state || "";
  const notte = st.toUpperCase().includes("NIGHT");

  document.body.classList.remove("hk-night","hk-day");
  document.body.classList.add(notte ? "hk-night" : "hk-day");
}

/*******************************************************
 * Flash aggiornamento card
 *******************************************************/
function flashUpdated(){
  document.querySelectorAll(".hk-card").forEach(card=>{
    card.classList.remove("update-flash");
    void card.offsetWidth;
    card.classList.add("update-flash");
  });
}

/*******************************************************
 * Loading shimmer
 *******************************************************/
function showLoading(){
  document.querySelectorAll(".hk-value, .person, .badge").forEach(el=>{
    el.classList.add("hk-shimmer");
  });
}
function hideLoading(){
  document.querySelectorAll(".hk-shimmer").forEach(el=>{
    el.classList.remove("hk-shimmer");
  });
}

/*******************************************************
 * Comandi
 *******************************************************/
async function sendPianteRetry(){
  for(let i=1;i<=3;i++){
    try{
      await sendJSONP(`${ENDPOINT}?admin=1&event=piante&value=true`);
      toast("ðŸŒ¿ Piante avviate");
      return;
    }catch(e){
      await delay(1500);
    }
  }
  toast("Errore PIANTE");
}

async function sendCmd(evt,val){
  if(evt==="piante") return sendPianteRetry();

  try{
    await sendJSONP(`${ENDPOINT}?admin=1&event=${evt}&value=${val?'true':'false'}`);
    toast("OK");
    setTimeout(loadModel,300);
  }catch(e){
    toast("Errore");
  }
}

/*******************************************************
 * Loader + Bind
 *******************************************************/
async function loadModel(){
  try{
    showLoading();
    const model = await sendJSONP(ENDPOINT);
    renderAll(model);
    applyTheme(model);
    flashUpdated();
  }catch(e){
    toast("Errore rete");
  }finally{
    hideLoading();
  }
}

function bindButtons(){
  document.querySelectorAll("[data-cmd]").forEach(btn=>{
    btn.addEventListener("click",()=>{
      const cmd = btn.dataset.cmd;
      const val = btn.dataset.val==="true";
      sendCmd(cmd,val);
    });
  });
}

document.addEventListener("DOMContentLoaded",()=>{
  bindButtons();
  loadModel();
  setInterval(loadModel,10000);
});

/*******************************************************
 *  HOMEKIT DARK THEME â€” BASE
 *******************************************************/
:root{
  --bg: #0d0f14;
  --bg2:#11141b;
  --text:#eaf0f7;
  --muted:#8b94a5;

  --card:#181d27;
  --card2:#1f2531;

  --accent:#0b84ff;
  --good:#27d17c;
  --warn:#ffb454;
  --bad:#ff6e6e;

  --radius:18px;
  --pad:16px;

  --shadow:0 8px 28px rgba(0,0,0,.34);
}

body{
  margin:0;
  background:var(--bg);
  color:var(--text);
  font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Helvetica,Arial,sans-serif;
  -webkit-font-smoothing: antialiased;
}

.fade-in{
  animation:fadeIn .6s ease both;
}
.slide-up{
  animation:slideUp .6s ease both;
}

@keyframes fadeIn {
  from{ opacity:0; transform:translateY(4px); }
  to{ opacity:1; transform:translateY(0); }
}

@keyframes slideUp {
  from{ opacity:0; transform:translateY(25px); }
  to{ opacity:1; transform:translateY(0); }
}

/*******************************************************
 *  CARDS â€“ HomeKit Dark
 *******************************************************/
.hk-container{
  max-width:1000px;
  margin:auto;
  padding:18px;
  display:grid;
  gap:18px;
}

.hk-card{
  background:var(--card);
  padding:var(--pad);
  border-radius:var(--radius);
  box-shadow:var(--shadow);
  border:1px solid rgba(255,255,255,.08);
  transform:translateZ(0);
  transition:background .3s;
}

.hk-card:hover{
  background:var(--card2);
}

.hk-card-title{
  font-size:16px;
  font-weight:600;
  margin-bottom:14px;
}

/*******************************************************
 *  GRID (per Stati, Orari, Piante)
 *******************************************************/
.hk-grid{
  display:grid;
  grid-template-columns:repeat(auto-fit,minmax(140px,1fr));
  gap:14px;
}

.hk-item{
  background:var(--card2);
  padding:12px;
  border-radius:var(--radius);
  border:1px solid rgba(255,255,255,.07);
  transition:all .25s;
}

.hk-item:hover{
  background:#242a37;
}

.hk-label{
  font-size:12px;
  color:var(--muted);
}

.hk-value{
  font-size:15px;
  margin-top:3px;
  font-weight:600;
}

/*******************************************************
 *  PERSONE â€” Lista stile HomeKit
 *******************************************************/
.hk-people{
  list-style:none;
  padding:0;
  margin:0;
  display:grid;
  gap:10px;
}

.person{
  background:var(--card2);
  border-radius:var(--radius);
  padding:12px 14px;
  display:flex;
  align-items:center;
  justify-content:space-between;
  border:1px solid rgba(255,255,255,.06);
  transition:.25s;
}

.person:hover{
  background:#242a37;
}

.badge{
  padding:5px 12px;
  border-radius:999px;
  font-size:12px;
  font-weight:600;
  transition:.25s;
}

.badge.in{
  background:rgba(39,209,124,.25);
  color:#98f7c9;
}

.badge.out{
  background:rgba(255,110,110,.22);
  color:#ffc9c9;
}

/*******************************************************
 *  BUTTONS â€” HomeKit Style
 *******************************************************/
.hk-grid-btn{
  display:flex;
  flex-direction:column;
  gap:12px;
}

.hk-btn{
  background:var(--card2);
  border:1px solid rgba(255,255,255,.08);
  border-radius:var(--radius);
  padding:14px;
  color:var(--text);
  font-weight:600;
  cursor:pointer;
  font-size:15px;
  transition:background .25s, transform .15s;
}

.hk-btn:hover{
  background:#232935;
}

.hk-btn:active{
  transform:scale(.95);
}

.hk-btn-big{
  font-size:17px;
  padding:16px;
}

.hk-btn-dual{
  display:grid;
  grid-template-columns:1fr 1fr;
  gap:10px;
}

.hk-btn-title{
  color:var(--muted);
  font-size:13px;
  margin-bottom:4px;
}

/*******************************************************
 *  iOS Style Press Animation
 *******************************************************/
.hk-press {
  animation: hkPress .18s cubic-bezier(.34,.07,.34,1.55);
}

@keyframes hkPress {
  0%   { transform: scale(1); }
  40%  { transform: scale(.92); background:#2a3143; }
  100% { transform: scale(1); }
}

/*******************************************************
 *  HomeKit Bloom Pulse Effect
 *******************************************************/
.hk-pulse {
  position: relative;
}

.hk-pulse::after {
  content: "";
  position: absolute;
  inset: 0;
  border-radius: var(--radius);
  background: rgba(255,255,255,.15);
  animation: hkPulseFx .45s ease-out;
}

@keyframes hkPulseFx {
  from { opacity: .75; transform: scale(.95); }
  to   { opacity: 0;   transform: scale(1.25); }
}

/*******************************************************
 *  BUTTONS â€” HomeKit Style
 *******************************************************/
.hk-grid-btn{
  display:flex;
  flex-direction:column;
  gap:12px;
}

.hk-btn{
  background:var(--card2);
  border:1px solid rgba(255,255,255,.08);
  border-radius:var(--radius);
  padding:14px;
  color:var(--text);
  font-weight:600;
  cursor:pointer;
  font-size:15px;
  transition:background .25s, transform .15s;
}

.hk-btn:hover{
  background:#232935;
}

.hk-btn:active{
  transform:scale(.95);
}

.hk-btn-big{
  font-size:17px;
  padding:16px;
}

.hk-btn-dual{
  display:grid;
  grid-template-columns:1fr 1fr;
  gap:10px;
}

.hk-btn-title{
  color:var(--muted);
  font-size:13px;
  margin-bottom:4px;
}

/*******************************************************
 *  iOS Style Press Animation
 *******************************************************/
.hk-press {
  animation: hkPress .18s cubic-bezier(.34,.07,.34,1.55);
}

@keyframes hkPress {
  0%   { transform: scale(1); }
  40%  { transform: scale(.92); background:#2a3143; }
  100% { transform: scale(1); }
}

/*******************************************************
 *  HomeKit Bloom Pulse Effect
 *******************************************************/
.hk-pulse {
  position: relative;
}

.hk-pulse::after {
  content: "";
  position: absolute;
  inset: 0;
  border-radius: var(--radius);
  background: rgba(255,255,255,.15);
  animation: hkPulseFx .45s ease-out;
}

@keyframes hkPulseFx {
  from { opacity: .75; transform: scale(.95); }
  to   { opacity: 0;   transform: scale(1.25); }
}
