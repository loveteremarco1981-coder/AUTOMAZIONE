// CONFIG: imposta URL del tuo Web App Apps Script const WEB_APP_URL='<<INSERISCI_WEB_APP_URL>>';let MODEL=null;function refreshModel(){const s=document.createElement('script');const sep=WEB_APP_URL.includes('?')?'&':'?';s.src=WEB_APP_URL+sep+'callback=onModel&_='+Date.now();s.onerror=()=>console.error('Errore JSONP');document.head.appendChild(s);}function callAdmin(event,value){const cb='onAdmin_'+Math.random().toString(36).slice(2);window[cb]=function(){delete window[cb];setTimeout(refreshModel,300);};const s=document.createElement('script');const u=new URL(WEB_APP_URL);u.searchParams.set('admin','1');u.searchParams.set('event',event);if(value!==undefined)u.searchParams.set('value',String(!!value));u.searchParams.set('callback',cb);s.src=u.toString();document.head.appendChild(s);}function onModel(model){MODEL=model;renderState(model);renderPeople(model);renderNext(model);const logs=document.getElementById('logs-anchor');logs.href=WEB_APP_URL+(WEB_APP_URL.includes('?')?'&':'?')+'logs=1';const foot=document.getElementById('footer-meta');foot.textContent=`Versione ${model?.meta?.version||''} · ${model?.meta?.tz||''} · ${new Date(model?.meta?.nowIso||Date.now()).toLocaleString()}`;decorateToggle('toggle_vacanza',!!model.vacanza);decorateToggle('toggle_override',!!model.override);}function renderState(model){const wrap=document.getElementById('state-cards');wrap.innerHTML='';const stateCard=document.createElement('div');stateCard.className='card';const st=(model.state||'—').replace(/_/g,' ');const notte=model.notte?'NOTTE':'GIORNO';stateCard.innerHTML=`<div class="title">Casa</div><div class="badge ${model.presenzaEffettiva?'ok':'warn'}"><span class="dot"></span><span>${model.presenzaEffettiva?'Occupata':'Vuota'}</span></div><div style="height:8px"></div><div class="badge"><span class="dot" style="background:#6aa9ff"></span><span>${st}</span></div><div style="height:8px"></div><div class="badge"><span class="dot" style="background:#ffd166"></span><span>${notte}</span></div>`;wrap.appendChild(stateCard);const w=model.weather||{};const meteo=document.createElement('div');meteo.className='card';const temp=(w.tempC!=null)?`${w.tempC.toFixed?w.tempC.toFixed(1):w.tempC}°C`:'—';meteo.innerHTML=`<div class="title">Meteo</div><div class="badge"><span class="dot" style="background:#00c2ff"></span><span>${w.iconEmoji||''} ${w.text||''} ${temp}</span></div><div class="muted" style="margin-top:6px">Fonte: ${w.provider||''}</div>`;wrap.appendChild(meteo);const alerts=document.createElement('div');alerts.className='card';alerts.innerHTML=`<div class="title">Alert</div><div class="badge ${model?.alerts?.logErrors?'warn':'ok'}"><span class="dot"></span><span>Log errori: ${model?.alerts?.logErrors||0}</span></div>`;wrap.appendChild(alerts);}function renderPeople(model){const list=document.getElementById('people-list');list.innerHTML='';(model.people||[]).forEach(p=>{const el=document.createElement('div');el.className='person '+(p.onlineSmart?'in':'out');const ini=(p.name||'?').charAt(0).toUpperCase();const meta=[];meta.push(p.onlineSmart?'IN':'OUT');if(p.lastLifeMinAgo!=null)meta.push(`${p.lastLifeMinAgo} min`);el.innerHTML=`<div class="avatar">${ini}</div><div><div class="title">${p.name}</div><div class="meta">${meta.join(' · ')}</div></div>`;list.appendChild(el);});}function renderNext(model){const wrap=document.getElementById('next-cards');wrap.innerHTML='';const nx=model.next||{};[['Piante (alba)',nx.pianteAlba],['Piante (post chiusura)',nx.piantePostClose],['Chiusura tardiva',nx.lateClose]].forEach(([label,val])=>{const c=document.createElement('div');c.className='card';c.innerHTML=`<div class="title">${label}</div><div class="muted">${val||'—'}</div>`;wrap.appendChild(c);});}function decorateToggle(action,on){const el=document.querySelector(`.tile[data-action="${action}"]`);if(!el)return;el.classList.toggle('on',!!on);}addEventListener('click',e=>{const tile=e.target.closest('.tile');if(!tile)return;const action=tile.dataset.action;if(action==='toggle_vacanza'){const next=!tile.classList.contains('on');callAdmin('set_vacanza',next);}else if(action==='toggle_override'){const next=!tile.classList.contains('on');callAdmin('set_override',next);}else if(action==='alza_tutto'){callAdmin('alza_tutto');}else if(action==='abbassa_tutto'){callAdmin('abbassa_tutto');}else if(action==='piante'){callAdmin('piante');}});addEventListener('DOMContentLoaded',()=>{document.getElementById('power-btn').addEventListener('click',()=>{const on=!(MODEL&&MODEL.override);callAdmin('set_override',on);});refreshModel();});